<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rune Hunters</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@400;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Comfortaa',cursive;background:#1a1410;color:#f4e4c1;overflow:hidden;display:flex;justify-content:center;align-items:center;height:100vh}
#gameContainer{width:100vw;height:100vh;position:relative}
#gameCanvas{width:100%;height:100%;display:block;image-rendering:pixelated}
#hud{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none}
.hud-element{pointer-events:all;background:rgba(42,24,16,0.9);border:2px solid #8b6f47;padding:10px 15px;color:#f4e4c1;box-shadow:0 2px 8px rgba(0,0,0,0.5);border-radius:15px}
.top-left{position:absolute;top:20px;left:20px;font-size:14px}
.bottom-left{position:absolute;bottom:20px;left:20px;font-size:14px;max-width:350px;max-height:400px;overflow-y:auto}
.top-right{position:absolute;top:20px;right:20px}
.top-right.touch{position:absolute;top:70px;left:20px}
.action-button{background:#5a4a3a;color:#f4e4c1;border:1px solid #8b6f47;padding:8px 15px;cursor:pointer;border-radius:10px;transition:background 0.1s;font-family:'Comfortaa',cursive;font-size:14px}
.action-button:hover{background:#6a5a4a}
.action-button.red{background:#a03030;border-color:#f05050}
.action-button.red:hover{background:#b04040}
.action-button:disabled{background:#3a3a3a;color:#6a6a6a;cursor:not-allowed}
.action-button:focus{outline:2px solid #ffd700}
#tutorialBox{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);max-width:500px;width:90%;text-align:center;padding:20px;font-size:16px;line-height:1.6;z-index:10}
.modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,0.75);display:flex;justify-content:center;align-items:center;z-index:1000}
.modal-content{background:#2a1810;border:4px solid #8b6f47;padding:30px;border-radius:20px;box-shadow:0 5px 20px rgba(0,0,0,0.8);width:90%;max-width:600px;max-height:80vh;overflow-y:auto;color:#f4e4c1;text-align:center}
.modal-content h2{margin-bottom:20px;color:#ffd700;font-size:24px}
.modal-content p{margin-bottom:15px;font-size:14px;line-height:1.6}
.modal-content button{margin:10px auto;display:block;width:90%}
#messageBox{position:absolute;bottom:80px;left:50%;transform:translateX(-50%);background:rgba(42,24,16,0.95);border:2px solid #8b6f47;padding:15px 25px;border-radius:15px;display:none;max-width:500px;text-align:center}
.artifact-info{text-align:left;margin:10px 0;font-size:12px;line-height:1.5}
#nightOverlay{position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,20,0.6);pointer-events:none;opacity:0;transition:opacity 1s ease-in-out}
.study-item{background:rgba(90,74,58,0.5);border:1px solid #8b6f47;padding:10px;margin:8px 0;border-radius:10px;text-align:left}
.study-item button{width:auto;padding:6px 12px;font-size:12px;margin:5px 5px 0 0}
.research-tree{display:grid;gap:15px;text-align:left;max-height:60vh;overflow-y:auto}
.research-node{background:rgba(90,74,58,0.3);border:2px solid #8b6f47;padding:15px;border-radius:15px;margin:10px 0}
.research-node.unlocked{background:rgba(50,100,50,0.3);border-color:#4a8a4a}
.research-node.locked{opacity:0.5}
.research-node button{width:auto;padding:6px 12px;font-size:12px;margin-top:5px}
.quest-pack{border:2px solid #8b6f47;padding:15px;margin:10px 0;border-radius:15px;background:rgba(90,74,58,0.3)}
.quest-pack.locked{opacity:0.5}
.quest-item{background:rgba(42,24,16,0.8);border:1px solid #8b6f47;padding:10px;margin:8px 0;border-radius:10px;text-align:left}
.quest-item.completed{background:rgba(50,100,50,0.3);border-color:#4a8a4a}
.quest-progress{background:#3a2a1a;height:10px;border-radius:5px;margin:5px 0;overflow:hidden}
.quest-progress-bar{background:#ffd700;height:100%;transition:width 0.3s}
.credits-section{text-align:left;line-height:1.8;margin:20px 0}
.credits-section h3{color:#ffd700;margin:15px 0 10px 0}
.keybinds-grid{display:grid;grid-template-columns:1fr 1fr;gap:15px;margin:20px 0;text-align:left}
.keybind-setting{display:flex;justify-content:space-between;align-items:center;background:rgba(90,74,58,0.5);padding:10px;border-radius:10px;border:1px solid #8b6f47}
.keybind-setting span{font-size:14px;font-weight:bold}
.keybind-btn{width:100px;text-align:center;font-weight:bold}
#tutorialOverlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);z-index:5;pointer-events:all;display:none}
#tutorialBox{z-index:1001}
.help-section{margin:15px 0;text-align:left;padding:10px;background:rgba(90,74,58,0.3);border-radius:10px}
.help-section h3{color:#ffd700;margin-bottom:5px}
#digsiteProgress{
  position:absolute;
   bottom: 330px; 
  width: 300px; 
  background:rgba(42,24,16,0.95);
  border:3px solid #8b6f47;
  padding:20px;
  border-radius:15px;
  display:none;
  text-align:center;
  z-index:100
}
.progress-bar-container{
  width: 100%; 
  height:30px;
  background:#3a2a1a;
  border:2px solid #8b6f47;
  border-radius:15px;
  overflow:hidden;
  margin:10px 0
}
.progress-bar-fill{height:100%;background:#ffd700;transition:width 0.3s}
.analysis-notes{background:rgba(60,50,40,0.5);padding:10px;margin:10px 0;border-left:3px solid #ffd700;border-radius:5px;text-align:left;font-size:13px;line-height:1.5}
.dpad{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);z-index:100;display:none}
.dpad-button{width:60px;height:60px;background:rgba(90,74,58,0.8);border:2px solid #8b6f47;border-radius:10px;margin:5px;display:flex;justify-content:center;align-items:center;color:#f4e4c1;font-size:24px;cursor:pointer;user-select:none;-webkit-user-select:none;touch-action:manipulation;-webkit-touch-callout:none}
.dpad-button:active{background:rgba(120,100,80,0.9)}
.dpad-up{grid-area:up}
.dpad-down{grid-area:down}
.dpad-left{grid-area:left}
.dpad-right{grid-area:right}
.dpad-up-left{grid-area:up-left}
.dpad-up-right{grid-area:up-right}
.dpad-down-left{grid-area:down-left}
.dpad-down-right{grid-area:down-right}
.dpad-grid{display:grid;grid-template-areas:'up-left up up-right''left center right''down-left down down-right';grid-template-columns:60px 60px 60px;grid-template-rows:60px 60px 60px;gap:5px}
.dpad-center{grid-area:center}
.control-scheme-option{display:flex;align-items:center;justify-content:center;margin:15px 0}
.control-scheme-option input[type="radio"]{margin-right:10px;transform:scale(1.2)}
.control-scheme-option label{font-size:16px;cursor:pointer}
</style>
</head>
<body>
<div id="gameContainer">
<canvas id="gameCanvas"></canvas>
<div id="nightOverlay"></div>
<div id="tutorialOverlay"></div>
<div id="hud">
<div id="topLeftPanel" class="hud-element top-left">
Time: <span id="timeDisplay">9:00 AM, Day 1</span><br>
Research Points: <span id="moneyDisplay">0</span>
</div>
<div id="topRightPanel" class="hud-element top-right">
<button id="researchTreeButton" class="action-button" tabindex="1">Research Tree</button>
<button id="settingsButton" class="action-button" tabindex="2">Settings</button>
</div>
<div id="bottomLeftPanel" class="hud-element bottom-left" style="display:none">
<strong>Collected Artifacts</strong><br>
<div id="inventoryDisplay"></div>
</div>

<div id="messageBox">
<p id="messageText"></p>
</div>
<div id="tutorialBox" class="hud-element" style="display:none">
<p id="tutorialText"></p>
<button id="nextTutorialButton" class="action-button" style="margin-top:10px" tabindex="3">Next</button>
</div>
</div>
<div id="settingsModal" class="modal-overlay" style="display:none">
<div class="modal-content">
<h2>Game Settings</h2>
<button id="controlsButton" class="action-button">Controls</button>

<button id="howToPlayButton" class="action-button" tabindex="16">How To Play</button>
<button id="restartTutorialInModal" class="action-button" tabindex="17">Restart Tutorial</button>
<button id="showCreditsButton" class="action-button" tabindex="18">Credits</button>
<button id="resetProgressButton" class="action-button red" tabindex="19">Reset All Progress</button>
<button id="closeSettingsModal" class="action-button" tabindex="20">Close</button>
</div>
</div>
<div id="controlsModal" class="modal-overlay" style="display:none">
<div class="modal-content">
<h2>Controls</h2>
<div style="display:flex;gap:10px;justify-content:center;margin-bottom:20px">
<button id="settingsSelectKeyboard" class="action-button">üéπ Keyboard Controls</button>
<button id="settingsSelectTouch" class="action-button">üì± Touch Controls (D-Pad)</button>
</div>
<div id="keybindsSection" style="display:none">
<div class="keybinds-grid">
<div class="keybind-setting">
<span>Move Up:</span>
<button id="keybind-up1-btn" class="action-button keybind-btn" onclick="startKeybindChange('up',0)" tabindex="4">W</button>
<button id="keybind-up2-btn" class="action-button keybind-btn" onclick="startKeybindChange('up',1)" tabindex="5">‚Üë</button>
</div>
<div class="keybind-setting">
<span>Move Down:</span>
<button id="keybind-down1-btn" class="action-button keybind-btn" onclick="startKeybindChange('down',0)" tabindex="6">S</button>
<button id="keybind-down2-btn" class="action-button keybind-btn" onclick="startKeybindChange('down',1)" tabindex="7">‚Üì</button>
</div>
<div class="keybind-setting">
<span>Move Left:</span>
<button id="keybind-left1-btn" class="action-button keybind-btn" onclick="startKeybindChange('left',0)" tabindex="8">A</button>
<button id="keybind-left2-btn" class="action-button keybind-btn" onclick="startKeybindChange('left',1)" tabindex="9">‚Üê</button>
</div>
<div class="keybind-setting">
<span>Move Right:</span>
<button id="keybind-right1-btn" class="action-button keybind-btn" onclick="startKeybindChange('right',0)" tabindex="10">D</button>
<button id="keybind-right2-btn" class="action-button keybind-btn" onclick="startKeybindChange('right',1)" tabindex="11">‚Üí</button>
</div>
<div class="keybind-setting">
<span>Interact:</span>
<button id="keybind-interact1-btn" class="action-button keybind-btn" onclick="startKeybindChange('interact',0)" tabindex="12">E</button>
<button id="keybind-interact2-btn" class="action-button keybind-btn" onclick="startKeybindChange('interact',1)" tabindex="13">-</button>
</div>
<div class="keybind-setting">
<span>Return:</span>
<button id="keybind-return1-btn" class="action-button keybind-btn" onclick="startKeybindChange('return',0)" tabindex="14">R</button>
<button id="keybind-return2-btn" class="action-button keybind-btn" onclick="startKeybindChange('return',1)" tabindex="15">-</button>
</div>
</div>
</div>
<button id="closeControlsModal" class="action-button">Back to Settings</button>
</div>
</div>
<div id="artifactModal" class="modal-overlay" style="display:none">
<div class="modal-content">
<h2 id="artifactName">Artifact Discovered!</h2>
<p id="artifactDescription"></p>
<button id="closeArtifactModal" class="action-button" tabindex="21">Continue Digging</button>
</div>
</div>
<div id="documentationModal" class="modal-overlay" style="display:none">
<div class="modal-content">
<h2>üìã Document Artifacts</h2>
<p id="documentationMessage">Processing your findings...</p>
<div id="documentationList"></div>
<button id="closeDocumentationModal" class="action-button" tabindex="22">Exit Lab</button>
</div>
</div>
<div id="sleepModal" class="modal-overlay" style="display:none">
<div class="modal-content">
<h2>üõèÔ∏è End of Day</h2>
<p id="sleepMessage">Rest up for tomorrow's excavations?</p>
<button id="confirmSleep" class="action-button" tabindex="24">Sleep (Start New Day)</button>
<button id="cancelSleep" class="action-button red" tabindex="25">Stay Awake</button>
</div>
</div>
<div id="researchTreeModal" class="modal-overlay" style="display:none">
<div class="modal-content">
<h2>Research Tree</h2>
<p>Unlock upgrades to improve your archaeological abilities</p>
<div id="researchTreeContent" class="research-tree"></div>
<button id="closeResearchTreeModal" class="action-button" tabindex="26">Close</button>
</div>
</div>
<div id="questBoardModal" class="modal-overlay" style="display:none">
<div class="modal-content">
<h2>üìã Quest Board</h2>
<p>Complete quests to unlock storyline discoveries and earn rewards!</p>
<div id="questBoardContent"></div>
<button id="closeQuestBoardModal" class="action-button" tabindex="27">Close</button>
</div>
</div>
<div id="creditsModal" class="modal-overlay" style="display:none">
<div class="modal-content">
<h2>üìú Game Credits</h2>
<div class="credits-section">
<p><strong>Version 3.7</strong></p>
<h3>Developers:</h3>
<p>FLL Team 56913</p>
<p>IDK R0b0c0ns</p>
<p>Claude Sonnet 4.5</p>
<p>Gemini 2.5 Pro</p>
<p>Gemini 3 Pro</p>
<p>devstral</p>
<p>Grok Code</p>
</div>
<button id="closeCreditsModal" class="action-button" tabindex="28">Close</button>
</div>
</div>
<div id="missionCompleteModal" class="modal-overlay" style="display:none">
<div class="modal-content">
<h2>üèÜ Mission Complete!</h2>
<p style="font-size:18px;color:#ffd700"><strong>Congratulations!</strong></p>
<p>You have completed the archaeological journey and uncovered the ancient secrets!</p>
<div class="credits-section">
<p><strong>Version 3.7</strong></p>
<h3>Developers:</h3>
<p>FLL Team 56913</p>
<p>IDK R0b0c0ns</p>
<p>Claude Sonnet 4.5</p>
<p>Gemini 2.5 Pro</p>
<p>Gemini 3 Pro</p>
<p>devstral</p>
<p>Grok Code</p>
</div>
<button id="continueExploringButton" class="action-button" tabindex="29">Continue Exploring</button>
<button id="closeMissionCompleteModal" class="action-button" tabindex="30">Return to Game</button>
</div>
</div>
<div id="lateNightModal" class="modal-overlay" style="display:none">
<div class="modal-content">
<h2>üåô It's Late...</h2>
<p>It's 11 PM. You should head to camp to sleep.</p>
<p>Time is frozen until you rest.</p>
<button id="closeLateNightModal" class="action-button" tabindex="31">Understood</button>
</div>
</div>
<div id="confirmModal" class="modal-overlay" style="display:none">
<div class="modal-content">
<h2>Reset Progress?</h2>
<p>Are you sure you want to reset all your progress?</p>
<p>This action cannot be undone and will restart the game.</p>
<button id="confirmResetBtn" class="action-button red" tabindex="32">Confirm Reset</button>
<button id="cancelResetBtn" class="action-button" tabindex="33">Cancel</button>
</div>
</div>
<div id="howToPlayModal" class="modal-overlay" style="display:none">
<div class="modal-content">
<h2>üìñ How To Play</h2>
<div class="help-section">
<h3>Movement</h3>
<p>Use <strong id="help-move-keys">WASD/Arrow Keys</strong> to move around the world.</p>
</div>
<div class="help-section">
<h3>Digging</h3>
<p>Dig sites have 5-10 hidden layers. Only one layer is visible at a time. Click tiles to excavate them instantly. Clear all tiles in a layer to reveal the next layer.</p>
</div>
<div class="help-section">
<h3>Artifacts</h3>
<p>Artifacts you collect appear in your inventory (bottom-left). They never disappear. Bring them to the Lab to document and earn research points.</p>
</div>
<div class="help-section">
<h3>Research Tree</h3>
<p>Spend research points to unlock upgrades. Each upgrade requires all previous tier upgrades to be unlocked first.</p>
</div>
<div class="help-section">
<h3>Camp & Lab</h3>
<p>Camp: Sleep to start a new day and generate new dig sites.<br>Lab: Document artifacts to earn Research Points.</p>
</div>
<div class="help-section">
<h3>Keybinds</h3>
<p>Interact / Exit Site: <strong id="help-interact-keys">E</strong><br>Secondary Return: <strong id="help-return-keys">R</strong></p>
</div>
<button id="closeHowToPlayModal" class="action-button" tabindex="34">Close</button>
</div>
</div>
</div>
<div id="controlSchemeModal" class="modal-overlay" style="display:none">
<div class="modal-content">
<h2>Choose Control Scheme</h2>
<p>Select your preferred control method:</p>
<div style="display:flex;gap:10px;justify-content:center">
<button id="selectKeyboard" class="action-button">Keyboard Controls</button>
<button id="selectTouch" class="action-button">Touch Controls (D-Pad)</button>
</div>
</div>
</div>
<div id="dpad" class="dpad">
<div class="dpad-grid">
<button id="dpad-up-left" class="dpad-button dpad-up-left" onpointerdown="handleDpadPress(event, 'up-left')" onpointerup="handleDpadRelease(event, 'up-left')" onpointercancel="handleDpadRelease(event, 'up-left')" onmouseleave="handleDpadRelease(event, 'up-left')" oncontextmenu="return false;">‚Üñ</button>
<button id="dpad-up" class="dpad-button dpad-up" onpointerdown="handleDpadPress(event, 'up')" onpointerup="handleDpadRelease(event, 'up')" onpointercancel="handleDpadRelease(event, 'up')" onmouseleave="handleDpadRelease(event, 'up')" oncontextmenu="return false;">‚Üë</button>
<button id="dpad-up-right" class="dpad-button dpad-up-right" onpointerdown="handleDpadPress(event, 'up-right')" onpointerup="handleDpadRelease(event, 'up-right')" onpointercancel="handleDpadRelease(event, 'up-right')" onmouseleave="handleDpadRelease(event, 'up-right')" oncontextmenu="return false;">‚Üó</button>
<button id="dpad-left" class="dpad-button dpad-left" onpointerdown="handleDpadPress(event, 'left')" onpointerup="handleDpadRelease(event, 'left')" onpointercancel="handleDpadRelease(event, 'left')" onmouseleave="handleDpadRelease(event, 'left')" oncontextmenu="return false;">‚Üê</button>
<button id="dpad-center" class="dpad-button dpad-center" onpointerdown="handleDpadPress(event, 'interact')" onpointerup="handleDpadRelease(event, 'interact')" onpointercancel="handleDpadRelease(event, 'interact')" onmouseleave="handleDpadRelease(event, 'interact')" oncontextmenu="return false;">‚óè</button>
<button id="dpad-right" class="dpad-button dpad-right" onpointerdown="handleDpadPress(event, 'right')" onpointerup="handleDpadRelease(event, 'right')" onpointercancel="handleDpadRelease(event, 'right')" onmouseleave="handleDpadRelease(event, 'right')" oncontextmenu="return false;">‚Üí</button>
<button id="dpad-down-left" class="dpad-button dpad-down-left" onpointerdown="handleDpadPress(event, 'down-left')" onpointerup="handleDpadRelease(event, 'down-left')" onpointercancel="handleDpadRelease(event, 'down-left')" onmouseleave="handleDpadRelease(event, 'down-left')" oncontextmenu="return false;">‚Üô</button>
<button id="dpad-down" class="dpad-button dpad-down" onpointerdown="handleDpadPress(event, 'down')" onpointerup="handleDpadRelease(event, 'down')" onpointercancel="handleDpadRelease(event, 'down')" onmouseleave="handleDpadRelease(event, 'down')" oncontextmenu="return false;">‚Üì</button>
<button id="dpad-down-right" class="dpad-button dpad-down-right" onpointerdown="handleDpadPress(event, 'down-right')" onpointerup="handleDpadRelease(event, 'down-right')" onpointercancel="handleDpadRelease(event, 'down-right')" onmouseleave="handleDpadRelease(event, 'down-right')" oncontextmenu="return false;">‚Üò</button>
</div>
</div>
<script>
const TILE_SIZE=32;
const MAP_WIDTH=45;
const MAP_HEIGHT=45;
const ARTIFACTS={
pottery1:{name:"Terra Sigillata Bowl",rarity:"common",value:15,description:"Red-gloss pottery widely traded across the Roman Empire. The stamped decoration indicates mass production in Gaulish workshops.",insights:["Popular trade good across Mediterranean","Manufacturing techniques spread through conquest","Similar styles found in Britain and Africa"]},
pottery2:{name:"Amphora Fragment",rarity:"common",value:12,description:"Storage vessel for wine, olive oil, or garum. The shape and clay composition reveal its origin and trade route.",insights:["Essential for maritime commerce","Different regions had distinct amphora styles","Contents identifiable through residue analysis"]},
coin1:{name:"Silver Denarius",rarity:"uncommon",value:45,description:"Roman silver coin featuring Emperor Trajan. Coins help date archaeological layers and track economic connections.",insights:["Portraiture propaganda tool for emperors","Debasement over time reflects economic decline","Found far beyond empire borders via trade"]},
coin2:{name:"Bronze Sestertius",rarity:"uncommon",value:40,description:"Large bronze coin with detailed imagery. The reverse depicts a military victory, common imperial propaganda.",insights:["Coins communicated political messages","Bronze denominations for daily transactions","Imagery reveals contemporary events"]},
tool1:{name:"Iron Strigil",rarity:"common",value:18,description:"Curved scraper used in Roman baths to remove oil and sweat. Essential grooming tool for all social classes.",insights:["Bathing central to Roman culture","Similar tools across vast geographic range","Manufacturing standardization evidence"]},
tool2:{name:"Bronze Fibula",rarity:"common",value:20,description:"Ornate brooch for fastening clothing. The design indicates regional fashion preferences and metalworking skill.",insights:["Practical yet decorative objects","Regional styles show cultural diversity","Evolution tracks fashion changes"]},
jewelry1:{name:"Gold Aureus Ring",rarity:"rare",value:100,description:"Finger ring incorporating a gold coin. Demonstrates wealth and possibly political allegiance to the emperor depicted.",insights:["Gold reserved for elite classes","Coin-rings show imperial loyalty","Similar designs across empire suggest workshops"]},
jewelry2:{name:"Carnelian Intaglio",rarity:"rare",value:95,description:"Carved gemstone seal showing Minerva. Used to stamp documents with personal signature in wax.",insights:["Literacy and legal documentation widespread","Gemstone trade from India and Arabia","Iconography reveals religious preferences"]},
tablet1:{name:"Wax Tablet Stylus",rarity:"uncommon",value:35,description:"Bronze writing implement for inscribing letters in wax-filled wooden tablets. Evidence of daily correspondence.",insights:["High literacy rates in urban areas","Reusable writing surfaces economical","Business records and letters preserved"]},
tablet2:{name:"Lead Curse Tablet",rarity:"epic",value:250,description:"Inscribed lead sheet from a sacred spring. Contains a curse requesting divine punishment for a thief.",insights:["Personal religious practices documented","Latin literacy across social classes","Magic and religion intertwined"]},
sculpture1:{name:"Marble Portrait Bust",rarity:"rare",value:120,description:"Life-sized head of a Roman matron. Hairstyle dates it to the Flavian period, showing fashion as chronological marker.",insights:["Portraiture emphasized social status","Hairstyles changed rapidly, aiding dating","Imported Greek marble for wealthy patrons"]},
sculpture2:{name:"Terracotta Figurine",rarity:"common",value:22,description:"Small household deity or decorative figure. Mass-produced for the lower classes to display in home shrines.",insights:["Religious practice at all economic levels","Standardized production for mass market","Regional deities alongside Roman pantheon"]},
seal1:{name:"Imperial Bulla",rarity:"rare",value:110,description:"Gold pendant worn by freeborn children until coming of age. Protective amulet and status symbol.",insights:["Life-stage rituals marked by objects","Gold bullae exclusive to upper classes","Protective magic widespread belief"]},
seal2:{name:"Signaculum Stamp",rarity:"uncommon",value:50,description:"Bronze seal for marking ownership of goods. Inscribed name proves literacy and commercial activity.",insights:["Personal property protection important","Commercial networks required identification","Administrative systems relied on seals"]},
weapon1:{name:"Gladius Hispaniensis",rarity:"rare",value:115,description:"Short sword used by Roman legionaries. Superior iron-working technology gave Rome military advantage.",insights:["Standardized military equipment","Iron technology from Celtic influences","Found in burial contexts shows veteran status"]},
weapon2:{name:"Pilum Head",rarity:"uncommon",value:48,description:"Javelin point designed to bend on impact, preventing reuse by enemies. Engineering innovation in warfare.",insights:["Military tactics drove technological innovation","Standardization across legions","Metalworking prowess of empire"]},
mosaic1:{name:"Geometric Mosaic Tessera",rarity:"rare",value:90,description:"Small colored stone cube from a floor mosaic. Geometric patterns decorated middle-class homes.",insights:["Artistic styles spread empire-wide","Local workshops copied elite fashions","Mathematics in decorative arts"]},
mosaic2:{name:"Figured Mosaic Panel",rarity:"epic",value:200,description:"Mythological scene depicting Neptune. Complex figural mosaics required master craftsmen and wealthy patrons.",insights:["Greek mythology remained culturally dominant","Workshop signatures sometimes preserved","Similar iconography across provinces shows cultural unity"]},
lamp1:{name:"Terracotta Oil Lamp",rarity:"common",value:16,description:"Mass-produced clay lamp with maker's stamp. Artificial lighting extended productive hours and social activities.",insights:["Factory production of household goods","Maker's marks track commercial networks","Design standardization across empire"]},
lamp2:{name:"Bronze Lucerna",rarity:"uncommon",value:42,description:"Multi-nozzle bronze lamp for wealthy households. More expensive and decorative than ceramic versions.",insights:["Material wealth visible in daily objects","Bronze lamps could be heirlooms","Decorative motifs show personal taste"]},
fresco1:{name:"Pompeian Red Fresco",rarity:"rare",value:105,description:"Wall painting fragment showing architectural illusion. Fourth Pompeian Style with elaborate fantasy architecture.",insights:["Interior decoration priority for Romans","Painting styles evolved over time","Volcanic preservation unique opportunity"]},
fresco2:{name:"Garden Scene Fresco",rarity:"rare",value:98,description:"Naturalistic painting of plants and birds. Romans brought nature indoors through trompe-l'oeil artworks.",insights:["Nature scenes created peaceful ambiance","Greek artistic influence strong","Pigments imported from across empire"]},
glass1:{name:"Blown Glass Unguentarium",rarity:"uncommon",value:38,description:"Small glass bottle for perfumes or oils. Glass-blowing revolution made glass affordable for middle classes.",insights:["Syrian innovation spread rapidly","Recycled glass common practice","Perfume trade from Arabia"]},
glass2:{name:"Millefiori Glass Bowl",rarity:"epic",value:220,description:"Multi-colored mosaic glass vessel. Complex technique requiring specialized knowledge and expensive materials.",insights:["Luxury goods for elite display","Mediterranean-wide trade in glass","Technical knowledge closely guarded"]},
inscr1:{name:"Funerary Inscription",rarity:"rare",value:108,description:"Marble tombstone with deceased's name, age, and profession. Commemorates a freed slave who became a merchant.",insights:["Social mobility possible through commerce","Freed slaves integral to economy","Commemoration important across classes"]},
inscr2:{name:"Building Dedication",rarity:"epic",value:240,description:"Stone block recording construction of public baths by a wealthy magistrate. Lists benefactor's political offices.",insights:["Public building displayed civic virtue","Political careers documented in stone","Infrastructure funded by private wealth"]},
statue1:{name:"Bronze Statuette of Mercury",rarity:"rare",value:112,description:"Small bronze figure of the messenger god. Household shrine deity or votive offering at a temple.",insights:["Personal religious devotion documented","Bronze casting widespread skill","Roman and local deities coexisted"]},
statue2:{name:"Venus Figurine",rarity:"uncommon",value:46,description:"Terracotta Venus figure from a domestic shrine. Love goddess popular across all social levels.",insights:["Domestic religious practices universal","Female deities prominent in worship","Mass production of religious items"]},
tile1:{name:"Roof Tile with Mark",rarity:"common",value:14,description:"Curved clay roof tile stamped with legion name. Military kilns produced standardized building materials.",insights:["Military infrastructure sophisticated","Legions self-sufficient in production","Standardization across provinces"]},
tile2:{name:"Hypocaust Tile",rarity:"uncommon",value:36,description:"Box tile from underfloor heating system. Engineering innovation that heated public baths and wealthy homes.",insights:["Advanced engineering for comfort","Roman concrete enabled complex structures","Heating systems show climate adaptation"]},
armor1:{name:"Lorica Segmentata Plate",rarity:"rare",value:118,description:"Iron plate armor segment from legionary kit. Superior protection through articulated metal strips.",insights:["Military equipment highly specialized","Iron industry enormous scale","Standardized legionary appearance"]},
armor2:{name:"Bronze Scale Armor",rarity:"rare",value:102,description:"Overlapping bronze scales sewn to fabric backing. Used by auxiliary cavalry and eastern legions.",insights:["Regional military traditions incorporated","Auxiliary units brought diverse equipment","Scale armor eastern origin"]},
medical1:{name:"Bronze Surgical Probe",rarity:"uncommon",value:44,description:"Medical instrument for wound examination and treatment. Roman medicine surprisingly advanced.",insights:["Professional medical practitioners widespread","Greek medical knowledge adopted","Surgical tools sophisticated"]},
medical2:{name:"Collyrium Stamp",rarity:"rare",value:94,description:"Stone stamp for eye medicine. Inscription names the physician and medication for specific conditions.",insights:["Pharmaceutical knowledge extensive","Doctor's reputation marked on product","Eye diseases common ailment"]},
weight1:{name:"Lead Steelyard Weight",rarity:"common",value:17,description:"Counterweight for Roman balance scales. Standardized weights enabled fair commerce across empire.",insights:["Standardized measurement systems","Commercial regulation by government","Lead abundant and malleable"]},
weight2:{name:"Bronze Measure",rarity:"uncommon",value:39,description:"Standard volume measure for grain sales. Stamped with official verification to prevent fraud.",insights:["Government regulated commerce","Grain supply critical to stability","Bronze durability ensured accuracy"]},
dice1:{name:"Bone Gaming Die",rarity:"common",value:19,description:"Six-sided die carved from animal bone. Gaming and gambling popular across all social classes.",insights:["Leisure activities universal","Games spread throughout empire","Similar forms to modern dice"]},
dice2:{name:"Loaded Lead Die",rarity:"uncommon",value:41,description:"Weighted die for cheating at games. Evidence that gambling fraud is ancient practice.",insights:["Human behavior consistent across time","Gaming important social activity","Cheating prompted regulations"]},
key1:{name:"Bronze Door Key",rarity:"common",value:21,description:"L-shaped key for tumbler lock. Roman locks surprisingly sophisticated with complex mechanisms.",insights:["Security concerns in urban areas","Lock technology advanced","Personal property protection"]},
key2:{name:"Iron Chest Lock",rarity:"uncommon",value:37,description:"Locking mechanism from strongbox. Wealthy households secured valuables with complex locks.",insights:["Wealth security paramount","Metalworking enabled complex mechanisms","Locksmithing specialized profession"]},
mirror1:{name:"Polished Bronze Mirror",rarity:"rare",value:96,description:"Hand mirror with decorated handle. Personal grooming important to Romans of both genders.",insights:["Appearance valued across genders","Bronze polishing sophisticated technique","Greek influence on personal care"]},
mirror2:{name:"Silver Hand Mirror",rarity:"epic",value:210,description:"Ornate silver mirror with mythological scene. Luxury item demonstrating exceptional wealth and craftsmanship.",insights:["Silver reserved for elite","Greek artisans employed by wealthy","Mythology in everyday objects"]},
tool3:{name:"Iron Hoe Blade",rarity:"common",value:20,description:"Agricultural tool from rural villa. Iron tools increased farming efficiency and productivity.",insights:["Agriculture backbone of economy","Iron tools widespread by empire","Rural life contrasts urban"]},
tool4:{name:"Surveying Groma",rarity:"rare",value:122,description:"Bronze surveying instrument for laying out straight roads and property boundaries. Roman engineering precision.",insights:["Engineering created empire infrastructure","Geometry applied practically","Standardized tools across provinces"]},
jewelry3:{name:"Glass Bead Necklace",rarity:"common",value:18,description:"Colorful glass beads strung together. Affordable jewelry for lower classes after glass-blowing invention.",insights:["Fashion accessible to all classes","Glass industry democratized luxury","Color preferences show personal taste"]},
jewelry4:{name:"Emerald Earrings",rarity:"legendary",value:500,description:"Gold earrings set with Egyptian emeralds. Extreme luxury indicating highest social status and wealth.",insights:["Gemstone trade from Egypt and beyond","Gold jewelry status symbol","Elite fashion influenced all classes"]},
pottery3:{name:"Samian Ware Cup",rarity:"common",value:13,description:"Red-gloss drinking vessel with relief decoration. Standard tableware found across Western provinces.",insights:["Standardized tableware empire-wide","Gaulish pottery industry massive scale","Style preferences spread through trade"]},
pottery4:{name:"African Red Slip Dish",rarity:"uncommon",value:43,description:"North African fine ware that replaced Samian pottery. Shift shows changing trade patterns in late empire.",insights:["Economic centers shifted over time","North African industry rose","Trade patterns reveal historical changes"]},
book1:{name:"Stylus and Wax Tablet",rarity:"uncommon",value:47,description:"Complete writing set with bronze stylus and wooden frame holding wax. Personal correspondence and accounts.",insights:["Literacy valued skill","Writing materials portable","Business records essential"]},
book2:{name:"Papyrus Fragment",rarity:"epic",value:230,description:"Egyptian papyrus with Latin text. Rare survival of perishable material preserves actual Roman handwriting.",insights:["Egypt supplied writing material","Dry climate preserved organics","Cursive script evolved regionally"]}
};
const RARITY_ORDER=['common','uncommon','rare','epic','legendary'];
const RESEARCH_TREE={
tier1:[
{id:'brush1',name:'Brush With Greatness',cost:150,effect:'Improved excavation techniques',tier:1,unlocked:false,prereqs:[]},
{id:'file',name:'File It Under History',cost:150,effect:'Advanced documentation methods',tier:1,unlocked:false,prereqs:[]},
{id:'cardio',name:'Cardio-facts Training',cost:200,effect:'+10% movement speed',tier:1,unlocked:false,prereqs:[]},
{id:'questpack1',name:'Open Sesame-Stone',cost:100,effect:'Unlock Quest Pack 1',tier:1,unlocked:false,prereqs:[]}
],
tier2:[
{id:'shovel1',name:'Shovel Some Respect',cost:250,effect:'Stronger digging tools',tier:2,unlocked:false,prereqs:['brush1']},
{id:'radar1',name:'Peek Performance',cost:300,effect:'See 2 layers',tier:2,unlocked:false,prereqs:['brush1']},
{id:'paperwork',name:'Paperwork Makes Dream Work',cost:500,effect:'Efficient archival system',tier:2,unlocked:false,prereqs:['file']},
{id:'questpack2',name:'Quest-ionable Methods',cost:300,effect:'Unlock Quest Pack 2',tier:2,unlocked:false,prereqs:['questpack1']}
],
tier3:[
{id:'brush2',name:'Brush Hour 2',cost:400,effect:'Fine-detail analysis tools',tier:3,unlocked:false,prereqs:['shovel1']},
{id:'scan1',name:'Scan-You-Dig-It?',cost:700,effect:'10% reveal chance',tier:3,unlocked:false,prereqs:['radar1']},
{id:'radar2',name:'Double-Down Detector',cost:600,effect:'See 3 layers',tier:3,unlocked:false,prereqs:['radar1']},
{id:'keep',name:'Keep It Together',cost:1100,effect:'Artifact preservation training',tier:3,unlocked:false,prereqs:['paperwork']},
{id:'questpack3',name:'Quest For Success',cost:900,effect:'Unlock Quest Pack 3',tier:3,unlocked:false,prereqs:['questpack2']}
],
tier4:[
{id:'shovel2',name:'Shovel With Punches',cost:600,effect:'Reinforced excavation gear',tier:4,unlocked:false,prereqs:['brush2']},
{id:'radar3',name:'Depth Charge',cost:1200,effect:'See 4 layers, +25% detect',tier:4,unlocked:false,prereqs:['scan1','radar2']},
{id:'map',name:'Map-tastic Insights',cost:900,effect:'Show digsite contents',tier:4,unlocked:false,prereqs:['keep']},
{id:'labgo',name:'Lab On the Go-pher',cost:2800,effect:'Field documentation',tier:4,unlocked:false,prereqs:['keep']},
{id:'questpack4',name:'A Quest-ion of Time',cost:1200,effect:'Unlock Quest Pack 4',tier:4,unlocked:false,prereqs:['questpack3']}
],
tier5:[
{id:'tools3',name:'Dig-nificantly Better',cost:1200,effect:'Master excavation kit',tier:5,unlocked:false,prereqs:['shovel2']},
{id:'radar4',name:'All-Seeing Eye-chaeology',cost:1800,effect:'See 5 layers, +50% detect',tier:5,unlocked:false,prereqs:['radar3']},
{id:'laser',name:'Laser Focused',cost:3000,effect:'30% reveal chance',tier:5,unlocked:false,prereqs:['radar3']},
{id:'research',name:'Research and Destroy',cost:2400,effect:'Advanced research methodology',tier:5,unlocked:false,prereqs:['map','labgo']},
{id:'victory',name:'Dig Victory',cost:4000,effect:'FINAL: Mission Complete!',tier:5,unlocked:false,prereqs:['tools3','radar4','laser','research']}
]
};
const QUEST_PACKS={
pack1:{name:"Beginner's Luck",unlock:'questpack1',quests:[
{id:'q1_1',name:'First Steps',desc:'Collect 5 artifacts',type:'collect',target:5,progress:0,completed:false,reward:50},
{id:'q1_3',name:'Complete Excavation',desc:'Complete 1 dig site',type:'digsite',target:1,progress:0,completed:false,reward:100}
]},
pack2:{name:"Intermediate Excavator",unlock:'questpack2',quests:[
{id:'q2_1',name:'Rare Finds',desc:'Collect 3 rare artifacts',type:'collectRare',target:3,progress:0,completed:false,reward:150},
{id:'q2_2',name:'Research Focus',desc:'Earn 500 research points',type:'earnRP',target:500,progress:0,completed:false,reward:200}
]},
pack3:{name:"Deep Digs",unlock:'questpack3',quests:[
{id:'q3_1',name:'Master Excavator',desc:'Complete 5 dig sites',type:'digsite',target:5,progress:0,completed:false,reward:300},
{id:'q3_2',name:'Epic Hunter',desc:'Collect 2 epic artifacts',type:'collectEpic',target:2,progress:0,completed:false,reward:350},
{id:'q3_3',name:'Knowledge Seeker',desc:'Earn 1500 research points',type:'earnRP',target:1500,progress:0,completed:false,reward:400}
]},
pack4:{name:"Legendary Discoveries",unlock:'questpack4',quests:[
{id:'q4_1',name:'Legendary Find',desc:'Collect 1 legendary artifact',type:'collectLegendary',target:1,progress:0,completed:false,reward:500},
{id:'q4_2',name:'Complete Collection',desc:'Collect 50 total artifacts',type:'collect',target:50,progress:0,completed:false,reward:600},
{id:'q4_3',name:'Research Master',desc:'Earn 3000 research points',type:'earnRP',target:3000,progress:0,completed:false,reward:700}
]}
};
const TUTORIAL_STEPS=[
{text:"Welcome to Rune Hunters! You're an archaeologist studying ancient Roman civilization. Your mission is to excavate artifacts and learn about the past."},
{text:"Archaeology is the study of human history through excavation and analysis of artifacts and structures. Each discovery helps us understand how people lived thousands of years ago."},
{text:"Move around using your movement keys. The map shows your research base and surrounding areas where dig sites will appear."},
{text:"Dig sites appear each day at 9 AM. Visit them during the day to excavate layered trenches."},
{text:"The central building is your Research Laboratory. Visit it to document your artifacts and earn Research Points!"},
{text:"When ready to sleep, enter your Camp building at night. This starts a new day with fresh dig sites. Time to begin your journey!"}
];

function getTutorialText(stepIndex) {
  const baseText = TUTORIAL_STEPS[stepIndex].text;

  if (stepIndex === 2) { // Movement step
    if (game.controlScheme === 'touch') {
      return "Use the on-screen D-pad to move around. The map shows your research base and surrounding areas where dig sites will appear.";
    } else {
      return "Use your movement keys to move around. The map shows your research base and surrounding areas where dig sites will appear.";
    }
  }

  return baseText;
}

function handleDpadPress(event, direction) {
  event.preventDefault();
  const dirs = direction.split('-');
  dirs.forEach(dir => {
    const key = game.keybinds[dir][0];
    game.keys[key] = true;
  });
}

function handleDpadRelease(event, direction) {
  event.preventDefault();
  const dirs = direction.split('-');
  dirs.forEach(dir => {
    const key = game.keybinds[dir][0];
    game.keys[key] = false;
  });
}

function updateDpadVisibility() {
  const dpad = document.getElementById('dpad');
  const modals = ['settingsModal', 'controlsModal', 'artifactModal', 'documentationModal', 'sleepModal', 'researchTreeModal', 'questBoardModal', 'creditsModal', 'missionCompleteModal', 'lateNightModal', 'confirmModal', 'howToPlayModal', 'controlSchemeModal'];
  const modalOpen = modals.some(id => document.getElementById(id).style.display === 'flex');
  if (game.controlScheme === 'touch' && !modalOpen) {
    dpad.style.display = 'block';
  } else {
    dpad.style.display = 'none';
  }
  game.zoomScale = 1.0;
}

function saveGame() {
  const saveData = {
    player: game.player,
    inventory: game.inventory,
    documentedArtifacts: game.documentedArtifacts,
    researchPoints: game.researchPoints,
    time: game.time,
    keybinds: game.keybinds,
    tutorialActive: game.tutorialActive,
    tutorialStep: game.tutorialStep,
    questProgress: game.questProgress,
    controlScheme: game.controlScheme,
    zoomScale: game.zoomScale,
    unlockedResearches: []
  };
  for(const tierKey in RESEARCH_TREE){
    RESEARCH_TREE[tierKey].forEach(upgrade => {
      if(upgrade.unlocked){
        saveData.unlockedResearches.push(upgrade.id);
      }
    });
  }
  localStorage.setItem('runehunters_save', JSON.stringify(saveData));
}

function loadGame() {
  const saved = localStorage.getItem('runehunters_save');
  if(saved){
    const saveData = JSON.parse(saved);
    Object.assign(game.player, saveData.player);
    game.inventory = saveData.inventory || {};
    game.documentedArtifacts = saveData.documentedArtifacts || {};
    game.researchPoints = saveData.researchPoints || 0;
    Object.assign(game.time, saveData.time);
    game.keybinds = saveData.keybinds || game.keybinds;
    game.tutorialActive = saveData.tutorialActive || false;
    game.tutorialStep = saveData.tutorialStep || 0;
    game.questProgress = saveData.questProgress || game.questProgress;
    game.controlScheme = saveData.controlScheme || 'keyboard';
    game.zoomScale = saveData.zoomScale || 1.0;
    if(saveData.unlockedResearches){
      saveData.unlockedResearches.forEach(id => {
        const upgrade = findResearchById(id);
        if(upgrade){
          upgrade.unlocked = true;
        }
      });
    }
  }
}

function showControlSchemeSelector() {
  document.getElementById('controlSchemeModal').style.display = 'flex';
  const selectedRadio = document.querySelector(`input[name="controlScheme"][value="${game.controlScheme}"]`);
  if (selectedRadio) {
    selectedRadio.checked = true;
  }
  updateDpadVisibility();
}
let game={
state:'town',
scene:'overworld',
player:{x:(MAP_WIDTH/2)*TILE_SIZE,y:(MAP_HEIGHT/2)*TILE_SIZE,speed:4,dx:0,dy:1,walkFrame:0,walkCounter:0,isWalking:false},
map:[],
mapObjects:[],
ambianceElements:[],
backgroundElements:[],
digsites:[],
paths:[],
currentDigsite:null,
inventory:{},
documentedArtifacts:{},
researchPoints:0,
time:{hour:9,minute:0,day:1,frameCounter:0},
keys:{},
keybinds:{up:['w','arrowup'],down:['s','arrowdown'],left:['a','arrowleft'],right:['d','arrowright'],interact:['e',''],return:['r','']},
tutorialActive:false,
tutorialStep:0,
offsetX:0,
offsetY:0,
isNight:false,
nightOpacity:0,
timeFrozen:false,
lateNightWarningShown:false,
labPopupShown:false,
questProgress:{totalCollected:0,totalDigsites:0,rareCollected:0,epicCollected:0,legendaryCollected:0, totalRPEarned: 0},
currentKeybindChange:null,
currentKeybindSlot:null,
controlScheme:'keyboard',
zoomScale:1.0,
interactPressed:false
};
const canvas=document.getElementById('gameCanvas');
const ctx=canvas.getContext('2d');
function resizeCanvas(){
canvas.width=window.innerWidth;
canvas.height=window.innerHeight;
}
function createMap(){
const map=Array(MAP_HEIGHT).fill(null).map(()=>Array(MAP_WIDTH).fill('g'));
const buildings = [
{type: 'b', width: 7, height: 5}, // lab
{type: 'h', width: 5, height: 5}, // camp
{type: 'q', width: 5, height: 5}  // quest
];
const placedBuildings = [];
for(const building of buildings){
let placed = false;
let attempts = 0;
while(!placed && attempts < 100){
const x = Math.floor(Math.random() * (MAP_WIDTH - building.width - 4)) + 2;
const y = Math.floor(Math.random() * (MAP_HEIGHT - building.height - 4)) + 2;
const distFromCenter = Math.sqrt(Math.pow(x + building.width/2 - MAP_WIDTH/2, 2) + Math.pow(y + building.height/2 - MAP_HEIGHT/2, 2));
if(distFromCenter > 10){
let clear = true;
for(let dy = 0; dy < building.height; dy++){
for(let dx = 0; dx < building.width; dx++){
if(map[y + dy][x + dx] !== 'g') clear = false;
}
}
let tooClose = false;
for (const pb of placedBuildings) {
  if (!(x + building.width + 2 <= pb.x || pb.x + pb.width + 2 <= x ||
        y + building.height + 2 <= pb.y || pb.y + pb.height + 2 <= y)) {
    tooClose = true;
    break;
  }
}
if(clear && !tooClose){
for(let dy = 0; dy < building.height; dy++){
for(let dx = 0; dx < building.width; dx++){
map[y + dy][x + dx] = building.type;
}
}
placedBuildings.push({x, y, width: building.width, height: building.height, type: building.type});
placed = true;
}
}
attempts++;
}
}
return map;
}
function generatePaths(){
game.paths = [];
}
function MapObject(x,y,type,name){
this.x=x;
this.y=y;
this.type=type;
this.name=name;
this.collider={x:x-10,y:y-10,w:20,h:20};
}
function isPositionBlocked(x,y){
if(x<0||x>=MAP_WIDTH||y<0||y>=MAP_HEIGHT)return true;
const tileType=game.map[y][x];
return tileType==='b'||tileType==='h'||tileType==='q'||tileType==='d'||tileType==='w';
}
function isBlockedForObject(x,y){
if(game.map[y][x] !== 'g') return true;
// Check buildings
if(game.map[y][x] === 'b' || game.map[y][x] === 'h' || game.map[y][x] === 'q') return true;
// Check distance to other trees and rocks
for(const obj of game.mapObjects){
if(Math.abs(obj.x/TILE_SIZE - x) <=1 && Math.abs(obj.y/TILE_SIZE - y) <=1) return true;
}
for(const amb of game.ambianceElements){
if(Math.abs(amb.x/TILE_SIZE - x) <=1 && Math.abs(amb.y/TILE_SIZE - y) <=1) return true;
}
return false;
}
function generateMapObjects(){
game.mapObjects=[];
const treeCount=MAP_WIDTH*MAP_HEIGHT/30;
for(let i=0;i<treeCount;i++){
let x,y,attempts=0;
do{
x= Math.floor(Math.random()*MAP_WIDTH);
y= Math.floor(Math.random()*MAP_HEIGHT);
attempts++;
if(attempts>1000)break;
}while(game.map[y][x]!=='g' || isBlockedForObject(x,y));
if(game.map[y][x]==='g' && !isBlockedForObject(x,y)){
game.mapObjects.push(new MapObject(x*TILE_SIZE+TILE_SIZE/2,y*TILE_SIZE+TILE_SIZE/2,'tree','Tree'));
}
}
}
function generateAmbiance(){
game.ambianceElements=[];
const rockCount=MAP_WIDTH*MAP_HEIGHT/35;
for(let i=0;i<rockCount;i++){
let x,y,attempts=0;
do{
x= Math.floor(Math.random()*MAP_WIDTH);
y= Math.floor(Math.random()*MAP_HEIGHT);
attempts++;
if(attempts>1000)break;
}while(game.map[y][x]!=='g' || isBlockedForObject(x,y));
if(game.map[y][x]==='g' && !isBlockedForObject(x,y)){
game.ambianceElements.push({x:x*TILE_SIZE+TILE_SIZE/2,y:y*TILE_SIZE+TILE_SIZE/2,type:'rock'});
}
}
}
function generateBackgroundElements(){
game.backgroundElements=[];
for(let i=0;i<15;i++){
game.backgroundElements.push({x:Math.random()*(MAP_WIDTH*TILE_SIZE),y:Math.random()*(MAP_HEIGHT*TILE_SIZE*0.4),type:'column',height:80+Math.random()*40});
}
for(let i=0;i<8;i++){
game.backgroundElements.push({x:Math.random()*(MAP_WIDTH*TILE_SIZE),y:Math.random()*(MAP_HEIGHT*TILE_SIZE*0.4),type:'arch',width:60+Math.random()*40});
}
game.backgroundElements.push({x:MAP_WIDTH*TILE_SIZE*0.8,y:MAP_HEIGHT*TILE_SIZE*0.15,type:'colosseum'});
}
function generateDigsites(){
for(let y=0;y<MAP_HEIGHT;y++){
for(let x=0;x<MAP_WIDTH;x++){
if(game.map[y][x]==='d'||game.map[y][x]==='w'){
game.map[y][x]='g';
}
}
}
game.digsites=[];
const existingDigsites=game.digsites.filter(d=>d.completed===false);
const newSitesNeeded=4-existingDigsites.length;
for(let i=0;i<newSitesNeeded;i++){
let placed=false;
let attempts=0;
while(!placed&&attempts<100){
const x=Math.floor(Math.random()*(MAP_WIDTH-5))+2;
const y=Math.floor(Math.random()*(MAP_HEIGHT-5))+2;
const distFromCenter=Math.sqrt(Math.pow(x-21,2)+Math.pow(y-12,2));
let width = 3, height = 3;
if(game.controlScheme === 'touch'){
width = Math.floor(Math.random()*4)+2;
height = Math.floor(Math.random()*4)+2;
}
let isClear=distFromCenter>10;
if(isClear){
for(let dy=0;dy<height;dy++){
for(let dx=0;dx<width;dx++){
if(game.map[y+dy]&&game.map[y+dy][x+dx]!=='g'){
isClear=false;
}
}
}
}
if(isClear){
for(let dy=0;dy<height;dy++){
for(let dx=0;dx<width;dx++){
game.map[y+dy][x+dx]='d';
}
}
const layers = game.controlScheme === 'touch' ? 5 : 5 + Math.floor(Math.random() * 6);
game.digsites.push({x:x+1,y:y+1,completed:false,grid:null,layers:layers,width:width,height:height});
placed=true;
}
attempts++;
}
}
generatePaths();
}
function generateDigsiteContent(digsite){
const rows=digsite.layers;
const cols = game.controlScheme === 'touch' ? 5 : 15;
digsite.grid=Array(rows).fill(null).map(()=>Array(cols).fill(null));
digsite.artifactCount=0;
digsite.dirtCount=0;
digsite.currentLayer=0;
const artifactTypes=Object.keys(ARTIFACTS);
const numArtifacts=Math.floor(rows*cols*0.15);
for(let i=0;i<numArtifacts;i++){
let placed=false;
while(!placed){
const x=Math.floor(Math.random()*cols);
const y=Math.floor(Math.random()*rows);
if(digsite.grid[y][x]===null){
const artifactType=artifactTypes[Math.floor(Math.random()*artifactTypes.length)];
digsite.grid[y][x]=artifactType;
digsite.artifactCount++;
placed=true;
}
}
}
digsite.dirtCount=(rows*cols)-digsite.artifactCount;
digsite.dugCells=Array(rows).fill(null).map(()=>Array(cols).fill(false));
}
function drawMap(){
for(let y=0;y<MAP_HEIGHT;y++){
for(let x=0;x<MAP_WIDTH;x++){
const tileX=x*TILE_SIZE+game.offsetX;
const tileY=y*TILE_SIZE+game.offsetY;
if(tileX>canvas.width||tileY>canvas.height||tileX<-TILE_SIZE||tileY<-TILE_SIZE)continue;
let color;
switch(game.map[y][x]){
case'g':color='#6b8e4e';break;
case'p':color='#a89070';break;
case'b':color='#8b7355';break;
case'h':color='#7a6a5a';break;
case'q':color='#8a7a6a';break;
case'd':color='#d4a574';break;
default:color='#6b8e4e';
}
ctx.fillStyle=color;
ctx.fillRect(tileX,tileY,TILE_SIZE,TILE_SIZE);
if(game.map[y][x]==='b'){
const top = (y === 0 || game.map[y-1][x] !== 'b');
const bottom = (y === MAP_HEIGHT-1 || game.map[y+1][x] !== 'b');
const wallColor = '#A09070'; // pale tan
const roofColor = '#B06060'; // muted red
if (top) {
ctx.fillStyle=roofColor;
ctx.fillRect(tileX, tileY, TILE_SIZE, TILE_SIZE);
} else if (bottom) {
ctx.fillStyle=wallColor;
ctx.fillRect(tileX, tileY, TILE_SIZE, TILE_SIZE);
// Door
ctx.fillStyle='#654321';
ctx.fillRect(tileX+12, tileY+16, 8, 16);
} else {
ctx.fillStyle=wallColor;
ctx.fillRect(tileX, tileY, TILE_SIZE, TILE_SIZE);
// Windows
ctx.fillStyle='rgba(0,0,0,0.4)';
ctx.fillRect(tileX+4, tileY+8, 6,6);
ctx.fillRect(tileX+12, tileY+8, 6,6);
ctx.fillRect(tileX+20, tileY+8, 6,6);
ctx.fillRect(tileX+4, tileY+18, 6,6);
ctx.fillRect(tileX+20, tileY+18, 6,6);
}
// Outline
ctx.strokeStyle='#654321';
ctx.lineWidth=1;
ctx.strokeRect(tileX,tileY,TILE_SIZE,TILE_SIZE);
}
if(game.map[y][x]==='h'){
const top = (y === 0 || game.map[y-1][x] !== 'h');
const bottom = (y === MAP_HEIGHT-1 || game.map[y+1][x] !== 'h');
const wallColor = '#708070'; // pale sage
const roofColor = '#F4A460'; // sandy brown
if (top) {
ctx.fillStyle=roofColor;
ctx.fillRect(tileX, tileY, TILE_SIZE, TILE_SIZE);
} else if (bottom) {
ctx.fillStyle=wallColor;
ctx.fillRect(tileX, tileY, TILE_SIZE, TILE_SIZE);
// Door
ctx.fillStyle='#0F5132';
ctx.fillRect(tileX+12, tileY+16, 8, 16);
} else {
ctx.fillStyle=wallColor;
ctx.fillRect(tileX, tileY, TILE_SIZE, TILE_SIZE);
// Windows
ctx.fillStyle='rgba(0,0,0,0.4)';
ctx.fillRect(tileX+4, tileY+8, 6,6);
ctx.fillRect(tileX+12, tileY+8, 6,6);
ctx.fillRect(tileX+20, tileY+8, 6,6);
ctx.fillRect(tileX+4, tileY+18, 6,6);
ctx.fillRect(tileX+20, tileY+18, 6,6);
}
// Outline
ctx.strokeStyle='#0F5132';
ctx.lineWidth=1;
ctx.strokeRect(tileX,tileY,TILE_SIZE,TILE_SIZE);
}
if(game.map[y][x]==='q'){
const top = (y === 0 || game.map[y-1][x] !== 'q');
const bottom = (y === MAP_HEIGHT-1 || game.map[y+1][x] !== 'q');
const wallColor = '#708090'; // pale blue
const roofColor = '#8B4513'; // saddlebrown for thatch
if (top) {
ctx.fillStyle=roofColor;
ctx.fillRect(tileX, tileY, TILE_SIZE, TILE_SIZE);
// Add thatch lines
ctx.strokeStyle='#654321';
ctx.lineWidth=1;
for(let i=0; i<5; i++){
ctx.beginPath();
ctx.moveTo(tileX + i*6, tileY);
ctx.lineTo(tileX + i*6 + 8, tileY + TILE_SIZE);
ctx.stroke();
}
} else if (bottom) {
ctx.fillStyle=wallColor;
ctx.fillRect(tileX, tileY, TILE_SIZE, TILE_SIZE);
// Door
ctx.fillStyle='#1E3A8A';
ctx.fillRect(tileX+12, tileY+16, 8, 16);
} else {
ctx.fillStyle=wallColor;
ctx.fillRect(tileX, tileY, TILE_SIZE, TILE_SIZE);
// Windows
ctx.fillStyle='rgba(0,0,0,0.4)';
ctx.fillRect(tileX+4, tileY+8, 6,6);
ctx.fillRect(tileX+12, tileY+8, 6,6);
ctx.fillRect(tileX+20, tileY+8, 6,6);
ctx.fillRect(tileX+4, tileY+18, 6,6);
ctx.fillRect(tileX+20, tileY+18, 6,6);
}
// Outline
ctx.strokeStyle='#1E3A8A';
ctx.lineWidth=1;
ctx.strokeRect(tileX,tileY,TILE_SIZE,TILE_SIZE);
}
ctx.fillStyle='#f4e4c1';
ctx.font='bold 18px Comfortaa';
ctx.textAlign='center';
function isRoofTile(y, x, type) {
  return game.map[y][x] === type && (y === 0 || game.map[y-1][x] !== type);
}
const buildingTitles = {'b': 'Lab', 'h': 'Camp', 'q': 'Quest'};
for(const type in buildingTitles){
  const title = buildingTitles[type];
  const chars = title.split('');
  let roofTiles = [];
  for(let y=0; y<MAP_HEIGHT; y++){
    for(let x=0; x<MAP_WIDTH; x++){
      if(isRoofTile(y, x, type)){
        roofTiles.push({x, y});
      }
    }
  }
  roofTiles.sort((a,b)=>a.x - b.x);
  for(let i=0; i<chars.length && i<roofTiles.length; i++){
    const tile = roofTiles[i];
    const tileX = tile.x * TILE_SIZE + game.offsetX;
    const tileY = tile.y * TILE_SIZE + game.offsetY;
    ctx.fillText(chars[i], tileX + TILE_SIZE/2, tileY + TILE_SIZE/2);
  }
}
}
}
game.digsites.forEach(site=>{
if(site.completed)return;
const centerX=site.x*TILE_SIZE+game.offsetX;
const centerY=site.y*TILE_SIZE+game.offsetY;
ctx.fillStyle='rgba(0,0,0,0.3)';
ctx.fillRect(centerX-TILE_SIZE,centerY+TILE_SIZE/2,TILE_SIZE*3,TILE_SIZE);
ctx.fillStyle='#f4e4c1';
ctx.font='bold 16px Comfortaa';
ctx.textAlign='center';
ctx.fillText('Dig Site',centerX+TILE_SIZE/2,centerY+TILE_SIZE*2-8);
});

}
function drawAmbiance(){
game.ambianceElements.forEach(amb=>{
const drawX=amb.x+game.offsetX;
const drawY=amb.y+game.offsetY;
if(amb.type==='rock'){
ctx.fillStyle='#7a7a7a';
ctx.beginPath();
ctx.arc(drawX,drawY,5,0,Math.PI*2);
ctx.fill();
ctx.fillStyle='#6a6a6a';
ctx.beginPath();
ctx.arc(drawX+3,drawY+3,3,0,Math.PI*2);
ctx.fill();
}
});
}
function drawMapObjects(){
game.mapObjects.sort((a,b)=>a.y-b.y);
game.mapObjects.forEach(obj=>{
const drawX=obj.x+game.offsetX;
const drawY=obj.y+game.offsetY;
if(obj.type==='tree'){
ctx.fillStyle='#5a4a3a';
ctx.fillRect(drawX-4,drawY+5,8,15);
ctx.fillStyle='#3a5a3a';
ctx.beginPath();
ctx.arc(drawX,drawY,15,0,Math.PI*2);
ctx.fill();
ctx.arc(drawX-8,drawY+5,10,0,Math.PI*2);
ctx.fill();
ctx.arc(drawX+8,drawY+5,10,0,Math.PI*2);
ctx.fill();
}
});
}
function drawPlayer(){
if(game.state==='digsite')return;
const size=24;
const x=canvas.width/2;
const y=canvas.height/2;
if(game.player.isWalking){
game.player.walkCounter++;
if(game.player.walkCounter>=8){
game.player.walkFrame=(game.player.walkFrame+1)%4;
game.player.walkCounter=0;
}
}else{
game.player.walkFrame=0;
game.player.walkCounter=0;
}
let leftLegOffset=0;
let rightLegOffset=0;
if(game.player.walkFrame===1){
leftLegOffset=3;
rightLegOffset=-3;
}else if(game.player.walkFrame===3){
leftLegOffset=-3;
rightLegOffset=3;
}
let armSwing=0;
if(game.player.walkFrame===1)armSwing=2;
else if(game.player.walkFrame===3)armSwing=-2;
ctx.fillStyle='rgba(0,0,0,0.3)';
ctx.fillRect(x-10,y+size-2,20,4);
ctx.fillStyle='#d4d4d4';
ctx.fillRect(x-10,y-12,20,18);
ctx.fillStyle='#6a4a3a';
ctx.fillRect(x-12,y-8,24,4);
ctx.fillStyle='#4a3a2a';
ctx.fillRect(x-10,y-4,20,3);
ctx.fillStyle='#d4a574';
ctx.fillRect(x-8,y+6,16,10);
ctx.fillStyle='#c49564';
ctx.fillRect(x-12,y+8-armSwing,4,6);
ctx.fillRect(x+8,y+8+armSwing,4,6);
ctx.fillStyle='#4a5a6a';
ctx.fillRect(x-4,y+8,2,8);
if(leftLegOffset!==0){
ctx.fillRect(x-4,y+16,2,leftLegOffset);
}
ctx.fillRect(x+2,y+8,2,8);
if(rightLegOffset!==0){
ctx.fillRect(x+2,y+16,2,rightLegOffset);
}
ctx.fillStyle='#5a4a3a';
ctx.fillRect(x-5,y+16+leftLegOffset,3,4);
ctx.fillRect(x+2,y+16+rightLegOffset,3,4);
}

function isWalkable(targetX,targetY){
const tileX=Math.floor(targetX/TILE_SIZE);
const tileY=Math.floor(targetY/TILE_SIZE);
if(tileX<0||tileX>=MAP_WIDTH||tileY<0||tileY>=MAP_HEIGHT)return false;
const tileType=game.map[tileY][tileX];
if(tileType==='g'||tileType==='p'||tileType==='d'){
for(const obj of game.mapObjects){
const dx=obj.x-targetX;
const dy=obj.y-targetY;
if(Math.abs(dx)<15&&Math.abs(dy)<15){
return false;
}
}
for(const amb of game.ambianceElements){
const dx=amb.x-targetX;
const dy=amb.y-targetY;
if(Math.abs(dx)<15&&Math.abs(dy)<15){
return false;
}
}
return true;
}
return false;
}
function getInteractionTarget(){
if(game.scene!=='overworld'){
return{type:'exit',name:'Exit Building'};
}
const interactX=game.player.x+(game.player.dx*TILE_SIZE);
const interactY=game.player.y+(game.player.dy*TILE_SIZE);
const tileX=Math.floor(interactX/TILE_SIZE);
const tileY=Math.floor(interactY/TILE_SIZE);
if(tileX>=0&&tileX<MAP_WIDTH&&tileY>=0&&tileY<MAP_HEIGHT){
const tileType=game.map[tileY][tileX];
if(tileType==='b'){
return{type:'building',name:'Research Laboratory',tileX,tileY};
}
if(tileType==='h'){
return{type:'home',name:'Camp',tileX,tileY};
}
if(tileType==='q'){
return{type:'quest',name:'Quest Room',tileX,tileY};
}
if(tileType==='d'){
return{type:'digsite',name:'Archaeological Dig Site',tileX,tileY};
}
}
return null;
}
function drawDigsite(){
const digsite=game.currentDigsite;
if(!digsite)return;
const rows=digsite.layers;
const cols=digsite.grid[0].length;
const cellSize=40;
const gridW=cols*cellSize;
const gridH=rows*cellSize;
const startX=(canvas.width-gridW)/2;
const startY=(canvas.height-gridH)/2;
ctx.fillStyle='#8b7355';
ctx.fillRect(0,0,canvas.width,canvas.height);
for(let y=0;y<rows;y++){
const layerShade=Math.floor(139-y*15);
const layerColor=`rgb(${layerShade},${Math.floor(layerShade*0.8)},${Math.floor(layerShade*0.6)})`;
ctx.fillStyle=layerColor;
ctx.fillRect(startX,startY+y*cellSize,gridW,cellSize);
}
for(let y=0;y<rows;y++){
for(let x=0;x<cols;x++){
const tileX=startX+x*cellSize;
const tileY=startY+y*cellSize;
const isDug=digsite.dugCells[y][x];
if(isDug){
const excavatedShade=Math.floor(160-y*10);
ctx.fillStyle=`rgb(${excavatedShade},${Math.floor(excavatedShade*0.75)},${Math.floor(excavatedShade*0.55)})`;
ctx.fillRect(tileX+2,tileY+2,cellSize-4,cellSize-4);
}else if(y===digsite.currentLayer){
ctx.fillStyle='#6a5545';
ctx.fillRect(tileX+2,tileY+2,cellSize-4,cellSize-4);
ctx.strokeStyle='#5a4535';
ctx.lineWidth=1;
ctx.strokeRect(tileX+2,tileY+2,cellSize-4,cellSize-4);
}else{
ctx.fillStyle='#4a3a2a';
ctx.fillRect(tileX+2,tileY+2,cellSize-4,cellSize-4);
}
}
}
ctx.fillStyle='#f4e4c1';
ctx.font='16px Comfortaa';
ctx.textAlign='center';
ctx.fillText(`Artifacts Remaining: ${digsite.artifactCount} | Layer: ${digsite.currentLayer+1}/${rows}`,canvas.width/2,startY-20);
const interactKey=game.keybinds.interact.filter(k=>k).map(k=>k.toUpperCase()).join(' / ');
ctx.fillText(`Press ${interactKey} to return to base`,canvas.width/2,startY-40);
}
function dig(mouseX,mouseY){
const digsite=game.currentDigsite;
if(!digsite)return;
const rows=digsite.layers;
const cols=digsite.grid[0].length;
const cellSize=40;
const gridW=cols*cellSize;
const gridH=rows*cellSize;
const startX=(canvas.width-gridW)/2;
const startY=(canvas.height-gridH)/2;
const gridX=Math.floor((mouseX-startX)/cellSize);
const gridY=Math.floor((mouseY-startY)/cellSize);
if(gridX>=0&&gridX<cols&&gridY>=0&&gridY<rows){
if(digsite.dugCells[gridY][gridX]){
return;
}
if(gridY!==digsite.currentLayer){
showMessage("You must clear the current layer first!");
return;
}
const x=gridX;
const y=gridY;
const cell=digsite.grid[y][x];
digsite.dugCells[y][x]=true;
if(cell&&cell!=='dug'){
const artifact=ARTIFACTS[cell];
game.inventory[cell]=(game.inventory[cell]||0)+1;
digsite.artifactCount--;
game.questProgress.totalCollected++;
if(artifact.rarity==='rare')game.questProgress.rareCollected++;
if(artifact.rarity==='epic')game.questProgress.epicCollected++;
if(artifact.rarity==='legendary')game.questProgress.legendaryCollected++;
updateQuestProgress();
showArtifactInfo(artifact);
}
let layerComplete=true;
for(let cx=0;cx<cols;cx++){
if(!digsite.dugCells[y][cx]){
layerComplete=false;
break;
}
}
if(layerComplete&&digsite.currentLayer<digsite.layers-1){
digsite.currentLayer++;
showMessage(`Layer ${digsite.currentLayer+1} unlocked!`);
}
updateHUD();
if(digsite.artifactCount===0){
game.questProgress.totalDigsites++;
updateQuestProgress();
const digsiteIndex=game.digsites.findIndex(d=>d===digsite);
if(digsiteIndex!==-1){
game.digsites[digsiteIndex].completed=true;
}
showMessage("All artifacts excavated! Return to the lab to document your findings.");
}
}
}
function showArtifactInfo(artifact){
document.getElementById('artifactName').textContent=artifact.name;
document.getElementById('artifactDescription').textContent=artifact.description;
document.getElementById('artifactModal').style.display='flex';
}
function updateGame(){
if(!game.timeFrozen&&!game.tutorialActive){
game.time.frameCounter++;
if(game.time.frameCounter>=30){
game.time.frameCounter=0;
game.time.minute++;
if(game.time.minute>=60){
game.time.minute=0;
game.time.hour++;
if(game.time.hour>=23){
game.time.hour=23;
game.time.minute=0;
game.timeFrozen=true;
if(!game.lateNightWarningShown){
game.lateNightWarningShown=true;
document.getElementById('lateNightModal').style.display='flex';
}
}
if(game.time.hour>=24){
game.time.hour=0;
}
}
}
}
game.isNight=game.time.hour>=18||game.time.hour<6;
const targetOpacity=game.isNight?0.6:0;
if(Math.abs(game.nightOpacity-targetOpacity)>0.01){
const fadeSpeed=0.01;
if(game.nightOpacity<targetOpacity){
game.nightOpacity=Math.min(game.nightOpacity+fadeSpeed,targetOpacity);
}else{
game.nightOpacity=Math.max(game.nightOpacity-fadeSpeed,targetOpacity);
}
document.getElementById('nightOverlay').style.opacity=game.nightOpacity;
}
if(game.time.hour>=17&&game.state==='digsite'){
game.state='town';
showMessage("The dig site closed for the day! Return tomorrow.");
document.getElementById('artifactModal').style.display='none';
}
if(game.state==='town'&&game.scene==='overworld'){
updatePlayerMovement();
updateCamera();
}
if((game.keys[game.keybinds.interact[0]] || game.keys[game.keybinds.interact[1]]) && !game.interactPressed){
if(game.state === 'digsite'){
game.state='town';
game.currentDigsite=null;
document.getElementById('artifactModal').style.display='none';
}else if(!game.tutorialActive){
handleInteraction();
}
game.interactPressed = true;
} else if(!game.keys[game.keybinds.interact[0]] && !game.keys[game.keybinds.interact[1]]) {
game.interactPressed = false;
}
updateHUD();
draw();
}
function updatePlayerMovement(){
let newX=game.player.x;
let newY=game.player.y;
let moving=false;
let speed=game.player.speed;
if(getResearchUnlocked('cardio'))speed*=1.1;
if(game.keys[game.keybinds.up[0]]||game.keys[game.keybinds.up[1]]){newY-=speed;moving=true;}
if(game.keys[game.keybinds.down[0]]||game.keys[game.keybinds.down[1]]){newY+=speed;moving=true;}
if(game.keys[game.keybinds.left[0]]||game.keys[game.keybinds.left[1]]){newX-=speed;moving=true;}
if(game.keys[game.keybinds.right[0]]||game.keys[game.keybinds.right[1]]){newX+=speed;moving=true;}
game.player.isWalking=moving;
if(newX!==game.player.x&&isWalkable(newX,game.player.y)){
game.player.x=newX;
}
if(newY!==game.player.y&&isWalkable(game.player.x,newY)){
game.player.y=newY;
}
if(moving){
if(game.keys[game.keybinds.up[0]]||game.keys[game.keybinds.up[1]]){game.player.dy=-1;game.player.dx=0;}
else if(game.keys[game.keybinds.down[0]]||game.keys[game.keybinds.down[1]]){game.player.dy=1;game.player.dx=0;}
else if(game.keys[game.keybinds.left[0]]||game.keys[game.keybinds.left[1]]){game.player.dx=-1;game.player.dy=0;}
else if(game.keys[game.keybinds.right[0]]||game.keys[game.keybinds.right[1]]){game.player.dx=1;game.player.dy=0;}
}
}
function updateCamera(){
game.offsetX=canvas.width/2-game.player.x*game.zoomScale;
game.offsetY=canvas.height/2-game.player.y*game.zoomScale;
}
function updateActionPrompt(){
const target=getInteractionTarget();
if(target){
document.getElementById('actionPrompt').style.display='block';
const interactKey=game.keybinds.interact.filter(k=>k).map(k=>k.toUpperCase()).join(' / ');
document.getElementById('promptText').textContent=`Press ${interactKey} to enter ${target.name}`;
}else{
document.getElementById('actionPrompt').style.display='none';
}
}
function updateHUD(){
const minutesFormatted=game.time.minute.toString().padStart(2,'0');
const timeFormatted=`${(game.time.hour%12)||12}:${minutesFormatted} ${game.time.hour<12?'AM':'PM'}`;
document.getElementById('timeDisplay').textContent=`${timeFormatted}, Day ${game.time.day}`;
document.getElementById('moneyDisplay').textContent=game.researchPoints;

let inventoryHtml='';
for(const artifactType in game.inventory){
  if(game.inventory[artifactType]>0){
  const artifact=ARTIFACTS[artifactType];
  inventoryHtml+=`<div class="artifact-info">${artifact.name}: ${game.inventory[artifactType]}</div>`;
  }
}

if (inventoryHtml !== '') {
  document.getElementById('inventoryDisplay').innerHTML=inventoryHtml;
  document.getElementById('bottomLeftPanel').style.display='block';
} else {
  document.getElementById('inventoryDisplay').innerHTML='';
  document.getElementById('bottomLeftPanel').style.display='none';
}
}
function showMessage(message){
document.getElementById('messageText').textContent=message;
document.getElementById('messageBox').style.display='block';
setTimeout(()=>{
document.getElementById('messageBox').style.display='none';
},4000);
}
function draw(){
ctx.fillStyle='#8b7355';
ctx.fillRect(0,0,canvas.width,canvas.height);
game.backgroundElements.forEach(elem=>{
const drawX=elem.x+game.offsetX*0.2;
const drawY=elem.y+game.offsetY*0.2;
if(elem.type==='column'){
ctx.fillStyle='rgba(200,180,160,0.4)';
ctx.fillRect(drawX-8,drawY,16,elem.height);
ctx.fillRect(drawX-10,drawY,20,8);
ctx.fillRect(drawX-10,drawY+elem.height-8,20,8);
}else if(elem.type==='arch'){
ctx.fillStyle='rgba(180,160,140,0.4)';
ctx.fillRect(drawX,drawY,elem.width,60);
ctx.beginPath();
ctx.arc(drawX+elem.width/2,drawY+60,elem.width/2,0,Math.PI,true);
ctx.fill();
}else if(elem.type==='colosseum'){
ctx.fillStyle='rgba(160,140,120,0.5)';
for(let i=0;i<3;i++){
ctx.beginPath();
ctx.ellipse(drawX,drawY+i*20,80,15,0,0,Math.PI*2);
ctx.fill();
}
for(let i=0;i<8;i++){
ctx.fillRect(drawX-70+i*20,drawY+10,6,40);
}
}
});
if(game.state==='town'){
if(game.scene==='overworld'){
drawMap();
drawAmbiance();
drawMapObjects();
drawPlayer();
}
}else if(game.state==='digsite'){
drawDigsite();
}
if(game.tutorialActive){
document.getElementById('tutorialOverlay').style.display='flex';
document.getElementById('tutorialBox').style.display='block';
document.getElementById('tutorialText').textContent=getTutorialText(game.tutorialStep);
document.getElementById('nextTutorialButton').textContent=(game.tutorialStep===TUTORIAL_STEPS.length-1)?'Start Excavating!':'Next';
}else{
document.getElementById('tutorialOverlay').style.display='none';
document.getElementById('tutorialBox').style.display='none';
}
}
function handleInteraction(){
if(game.tutorialActive&&game.tutorialStep<TUTORIAL_STEPS.length-1){
return;
}

if(game.state==='town'&&game.scene==='overworld'){
const target=getInteractionTarget(); // Get target
if(target){
if(target.type==='building'&&target.name==='Research Laboratory'){
documentArtifacts(); // Call modal directly
}else if(target.type==='home'){
if(game.isNight || game.time.hour >= 23){ // Check time
showSleepModal();
} else {
showMessage("You can only sleep at night (after 6 PM).");
}
}else if(target.type==='quest'){
showQuestBoard(); // Call modal directly
}else if(target.type==='digsite'){
if(game.time.hour>=9&&game.time.hour<17){
const digsite=game.digsites.find(d=>Math.abs(d.x-target.tileX)<=1&&Math.abs(d.y-target.tileY)<=1);
if(digsite&&!digsite.completed){
if(!digsite.grid){
generateDigsiteContent(digsite);
}
game.currentDigsite=digsite;
game.state='digsite';
showMessage("Excavation site entered. Click carefully to uncover artifacts!");
}else{
showMessage("This dig site has been fully excavated.");
}
}else{
showMessage("Dig sites are only open from 9 AM to 5 PM.");
}
}
}
}

}
function showSleepModal(){
document.getElementById('sleepMessage').textContent = "Rest up for tomorrow's excavations?";
document.getElementById('sleepModal').style.display='flex';
}
function startNewDay(){
game.time.hour=9;
game.time.minute=0;
game.time.day++;
game.timeFrozen=false;
game.lateNightWarningShown=false;
game.map = createMap();
generateDigsites();
generateMapObjects();
generateAmbiance();
saveGame();
document.getElementById('sleepModal').style.display='none';
game.scene='overworld';
showMessage(`Day ${game.time.day}: New dig sites have been discovered! Check your map.`);
}
function documentArtifacts(){
let totalValue=0;
let documentedItems=[];
const docList=document.getElementById('documentationList');
docList.innerHTML='';

for(const artifactType in game.inventory){
  const toDocument = game.inventory[artifactType] || 0;
  
  if(toDocument > 0){
  const artifact=ARTIFACTS[artifactType];
  let value=toDocument*artifact.value;
  totalValue+=value;
  
  // Add to documented list (for tracking totals, if needed)
  game.documentedArtifacts[artifactType] = (game.documentedArtifacts[artifactType] || 0) + toDocument;
  // Remove from active inventory
  game.inventory[artifactType] = 0; 

  documentedItems.push(`${toDocument}x ${artifact.name}`);
  const itemDiv=document.createElement('div');
  itemDiv.className='study-item';
  itemDiv.innerHTML=`<strong>${toDocument}x ${artifact.name}</strong><br><small>+${value} Research Points</small>`;
  docList.appendChild(itemDiv);
  }
}

if(totalValue>0){
  game.researchPoints+=totalValue;
  game.questProgress.totalRPEarned += totalValue; // Add to total earned
  updateQuestProgress();
  saveGame();
  document.getElementById('documentationMessage').textContent=`Successfully documented ${documentedItems.length} new artifact type(s)!`;
}else{
  document.getElementById('documentationMessage').textContent='No new artifacts to document. Go excavate some dig sites!';
}

updateHUD();
document.getElementById('documentationModal').style.display='flex';
updateDpadVisibility();
}
function showResearchTree(){
const content=document.getElementById('researchTreeContent');
content.innerHTML='';
for(let tier=1;tier<=5;tier++){
const tierKey='tier'+tier;
if(!RESEARCH_TREE[tierKey])continue;
const tierDiv=document.createElement('div');
tierDiv.innerHTML=`<h3 style="color:#ffd700;margin:10px 0">Tier ${tier}</h3>`;
RESEARCH_TREE[tierKey].forEach(upgrade=>{
const canUnlock=canUnlockResearch(upgrade);
const nodeDiv=document.createElement('div');
nodeDiv.className=`research-node ${upgrade.unlocked?'unlocked':''} ${!canUnlock?'locked':''}`;
nodeDiv.innerHTML=`
<strong>${upgrade.name}</strong> - ${upgrade.cost} RP<br>
<small>${upgrade.effect}</small><br>
${upgrade.unlocked?'<span style="color:#4a8a4a">‚úì Unlocked</span>':
canUnlock?`<button class="action-button" onclick="unlockResearch('${upgrade.id}')">Unlock</button>`:
'<span style="color:#8a4a4a">Requires prerequisites</span>'}</p>
`;
tierDiv.appendChild(nodeDiv);
});
content.appendChild(tierDiv);
}
document.getElementById('researchTreeModal').style.display='flex';
updateDpadVisibility();
}
function canUnlockResearch(upgrade){
if(upgrade.unlocked)return false;
if(game.researchPoints<upgrade.cost)return false;
for(const prereqId of upgrade.prereqs){
const prereq=findResearchById(prereqId);
if(!prereq||!prereq.unlocked)return false;
}
if(upgrade.tier > 1){
  const prevTier = 'tier' + (upgrade.tier - 1);
  if(RESEARCH_TREE[prevTier]){
    for(const prevUpgrade of RESEARCH_TREE[prevTier]){
      if(!prevUpgrade.unlocked) return false;
    }
  }
}
return true;
}
function findResearchById(id){
for(const tierKey in RESEARCH_TREE){
const upgrade=RESEARCH_TREE[tierKey].find(u=>u.id===id);
if(upgrade)return upgrade;
}
return null;
}
function getResearchUnlocked(id){
const upgrade=findResearchById(id);
return upgrade?upgrade.unlocked:false;
}
function unlockResearch(id){
const upgrade=findResearchById(id);
if(upgrade&&canUnlockResearch(upgrade)){
upgrade.unlocked=true;
game.researchPoints-=upgrade.cost;
updateHUD();
showMessage(`Unlocked: ${upgrade.name}!`);
saveGame();
if(id==='victory'){
setTimeout(()=>{
document.getElementById('missionCompleteModal').style.display='flex';
},1000);
}
showResearchTree();
return;
}
}
function showQuestBoard(){
const content=document.getElementById('questBoardContent');
content.innerHTML='';
for(const packKey in QUEST_PACKS){
const pack=QUEST_PACKS[packKey];
const isUnlocked=getResearchUnlocked(pack.unlock);
const packDiv=document.createElement('div');
packDiv.className=`quest-pack ${!isUnlocked?'locked':''}`;
packDiv.innerHTML=`<h3>${pack.name} ${!isUnlocked?'üîí':''}</h3>`;
if(isUnlocked){
pack.quests.forEach(quest=>{
const questDiv=document.createElement('div');
questDiv.className=`quest-item ${quest.completed?'completed':''}`;
const progressPercent=Math.min(100,(quest.progress/quest.target)*100);
questDiv.innerHTML=`
<strong>${quest.name}</strong><br>
<small>${quest.desc}</small><br>
<div class="quest-progress">
<div class="quest-progress-bar" style="width:${progressPercent}%"></div>
</div>
<small>Progress: ${quest.progress}/${quest.target}</small><br>
<small>Reward: ${quest.reward} RP</small>
${quest.completed?'<br><span style="color:#4a8a4a">‚úì Completed!</span>':''}
`;
packDiv.appendChild(questDiv);
});
}else{
packDiv.innerHTML+=`<p>Unlock "${pack.unlock}" in the Research Tree to access these quests.</p>`;
}
content.appendChild(packDiv);
}
document.getElementById('questBoardModal').style.display='flex';
}
function updateQuestProgress(){
for(const packKey in QUEST_PACKS){
const pack=QUEST_PACKS[packKey];
if(!getResearchUnlocked(pack.unlock))continue;
pack.quests.forEach(quest=>{
if(quest.completed)return;
let newProgress=0;
switch(quest.type){
case'collect':
newProgress=game.questProgress.totalCollected;
break;
case'digsite':
newProgress=game.questProgress.totalDigsites;
break;
case'collectRare':
newProgress=game.questProgress.rareCollected;
break;
case'collectEpic':
newProgress=game.questProgress.epicCollected;
break;
case'collectLegendary':
newProgress=game.questProgress.legendaryCollected;
break;
case'earnRP':
newProgress=game.questProgress.totalRPEarned; // Check totalRPEarned
break;
}
quest.progress=newProgress;
if(quest.progress>=quest.target&&!quest.completed){
quest.completed=true;
game.researchPoints+=quest.reward;
game.questProgress.totalRPEarned += quest.reward; // Add reward to totalRPEarned
showMessage(`Quest completed: ${quest.name}! Earned ${quest.reward} RP!`);
}
});
}
}
function handleKeydown(e){
if(game.controlScheme === 'touch') return;
const pressedKey=e.key.toLowerCase();
if(game.currentKeybindChange!==null){
const action=game.currentKeybindChange;
const slot=game.currentKeybindSlot;
if(Object.values(game.keybinds).flat().includes(pressedKey)&&pressedKey!==''){
showMessage("Key already in use!");
}else if(pressedKey.length>1&&!['arrowup','arrowdown','arrowleft','arrowright','space'].includes(pressedKey)){
showMessage("Please choose a simpler key.");
}else{
game.keybinds[action][slot]=pressedKey;
showMessage(`Set ${action} slot ${slot+1} to ${pressedKey.toUpperCase()}`);
}
populateKeybinds();
game.currentKeybindChange=null;
game.currentKeybindSlot=null;
e.preventDefault();
return;
}
game.keys[pressedKey]=true;
if(game.state==='digsite'&&game.keybinds.return.includes(pressedKey)){
game.state='town';
game.currentDigsite=null;
showMessage("Returning to base camp.");
document.getElementById('artifactModal').style.display='none';
}
if(game.currentKeybindChange !== null){
populateKeybinds();
game.currentKeybindChange = null;
game.currentKeybindSlot = null;
}
}
function handleKeyup(e){
if(game.controlScheme === 'touch') return;
game.keys[e.key.toLowerCase()]=false;
}
function handleMouseClick(e){
if(game.state==='digsite'){
dig(e.clientX,e.clientY);
}
}
document.getElementById('nextTutorialButton').addEventListener('click',()=>{
if(!game.tutorialActive)return;
game.tutorialStep++;
if(game.tutorialStep>=TUTORIAL_STEPS.length){
game.tutorialActive=false;
game.tutorialStep=0;
}
});
document.getElementById('controlsButton').addEventListener('click',()=>{
const keybindsSection = document.getElementById('keybindsSection');
if (game.controlScheme === 'keyboard') {
  keybindsSection.style.display = 'block';
} else {
  keybindsSection.style.display = 'none';
}
populateKeybinds();
document.getElementById('controlsModal').style.display='flex';
});
document.getElementById('settingsSelectKeyboard').addEventListener('click',()=>{
game.controlScheme = 'keyboard';
updateDpadVisibility();
document.getElementById('keybindsSection').style.display = 'block';
});
document.getElementById('settingsSelectTouch').addEventListener('click',()=>{
game.controlScheme = 'touch';
generateDigsites();
updateDpadVisibility();
document.getElementById('keybindsSection').style.display = 'none';
});
document.getElementById('closeControlsModal').addEventListener('click',()=>{
document.getElementById('controlsModal').style.display='none';
});
document.getElementById('settingsButton').addEventListener('click',()=>{
document.getElementById('settingsModal').style.display='flex';
});
document.getElementById('closeSettingsModal').addEventListener('click',()=>{
if(document.getElementById('controlsModal').style.display === 'flex'){
document.getElementById('controlsModal').style.display='none';
return;
}
document.getElementById('settingsModal').style.display='none';
});
document.getElementById('restartTutorialInModal').addEventListener('click',()=>{
game.tutorialActive=true;
game.tutorialStep=0;
document.getElementById('settingsModal').style.display='none';
showMessage("Tutorial restarted.");
});
document.getElementById('resetProgressButton').addEventListener('click',()=>{
document.getElementById('settingsModal').style.display='none';
document.getElementById('confirmModal').style.display='flex';
});
document.getElementById('confirmResetBtn').addEventListener('click',()=>{
localStorage.removeItem('runehunters_save');
location.reload();
});
document.getElementById('cancelResetBtn').addEventListener('click',()=>{
document.getElementById('confirmModal').style.display='none';
document.getElementById('settingsModal').style.display='flex';
});
document.getElementById('closeArtifactModal').addEventListener('click',()=>{
document.getElementById('artifactModal').style.display='none';
});
document.getElementById('confirmSleep').addEventListener('click',()=>{
startNewDay();
});
document.getElementById('cancelSleep').addEventListener('click',()=>{
document.getElementById('sleepModal').style.display='none';
});
document.getElementById('researchTreeButton').addEventListener('click',()=>{
showResearchTree();
});
document.getElementById('closeResearchTreeModal').addEventListener('click',()=>{
document.getElementById('researchTreeModal').style.display='none';
updateDpadVisibility();
});
document.getElementById('closeQuestBoardModal').addEventListener('click',()=>{
document.getElementById('questBoardModal').style.display='none';
});
document.getElementById('showCreditsButton').addEventListener('click',()=>{
document.getElementById('settingsModal').style.display='none';
document.getElementById('creditsModal').style.display='flex';
});
document.getElementById('closeCreditsModal').addEventListener('click',()=>{
document.getElementById('creditsModal').style.display='none';
});
document.getElementById('continueExploringButton').addEventListener('click',()=>{
document.getElementById('missionCompleteModal').style.display='none';
});
document.getElementById('closeMissionCompleteModal').addEventListener('click',()=>{
document.getElementById('missionCompleteModal').style.display='none';
});
document.getElementById('closeLateNightModal').addEventListener('click',()=>{
document.getElementById('lateNightModal').style.display='none';
});
document.getElementById('closeDocumentationModal').addEventListener('click',()=>{
document.getElementById('documentationModal').style.display='none';
});
document.getElementById('howToPlayButton').addEventListener('click',()=>{
document.getElementById('settingsModal').style.display='none';
const moveKeys=game.keybinds.up.filter(k=>k).map(k=>k.toUpperCase()).join('/');
const interactKeys=game.keybinds.interact.filter(k=>k).map(k=>k.toUpperCase()).join('/');
const returnKeys=game.keybinds.return.filter(k=>k).map(k=>k.toUpperCase()).join('/');
document.getElementById('help-move-keys').textContent=moveKeys;
document.getElementById('help-interact-keys').textContent=interactKeys;
document.getElementById('help-return-keys').textContent=returnKeys;
document.getElementById('howToPlayModal').style.display='flex';
});
document.getElementById('closeHowToPlayModal').addEventListener('click',()=>{
document.getElementById('howToPlayModal').style.display='none';
document.getElementById('settingsModal').style.display='flex';
});
document.getElementById('selectKeyboard').addEventListener('click',()=>{
  game.controlScheme = 'keyboard';
  document.getElementById('controlSchemeModal').style.display='none';
  updateDpadVisibility();
  game.tutorialActive = true;
  game.tutorialStep = 0;
});
document.getElementById('selectTouch').addEventListener('click',()=>{
  game.controlScheme = 'touch';
  document.getElementById('controlSchemeModal').style.display='none';
  updateDpadVisibility();
  game.tutorialActive = true;
  game.tutorialStep = 0;
});
function populateKeybinds(){
document.getElementById('keybind-up1-btn').textContent=game.keybinds.up[0].toUpperCase();
document.getElementById('keybind-up2-btn').textContent=game.keybinds.up[1]?game.keybinds.up[1].toUpperCase():'-';
document.getElementById('keybind-down1-btn').textContent=game.keybinds.down[0].toUpperCase();
document.getElementById('keybind-down2-btn').textContent=game.keybinds.down[1]?game.keybinds.down[1].toUpperCase():'-';
document.getElementById('keybind-left1-btn').textContent=game.keybinds.left[0].toUpperCase();
document.getElementById('keybind-left2-btn').textContent=game.keybinds.left[1]?game.keybinds.left[1].toUpperCase():'-';
document.getElementById('keybind-right1-btn').textContent=game.keybinds.right[0].toUpperCase();
document.getElementById('keybind-right2-btn').textContent=game.keybinds.right[1]?game.keybinds.right[1].toUpperCase():'-';
document.getElementById('keybind-interact1-btn').textContent=game.keybinds.interact[0].toUpperCase();
document.getElementById('keybind-interact2-btn').textContent=game.keybinds.interact[1]?game.keybinds.interact[1].toUpperCase():'-';
document.getElementById('keybind-return1-btn').textContent=game.keybinds.return[0].toUpperCase();
document.getElementById('keybind-return2-btn').textContent=game.keybinds.return[1]?game.keybinds.return[1].toUpperCase():'-';

const settingsSelectedRadio = document.querySelector(`input[name="settingsControlScheme"][value="${game.controlScheme}"]`);
if (settingsSelectedRadio) {
  settingsSelectedRadio.checked = true;
}
}
function startKeybindChange(action,slot){
game.currentKeybindChange=action;
game.currentKeybindSlot=slot;
document.getElementById(`keybind-${action}${slot+1}-btn`).textContent="...";
showMessage(`Press any key to set new bind for: ${action.toUpperCase()} slot ${slot+1}`);
}
window.unlockResearch=unlockResearch;
window.startKeybindChange=startKeybindChange;
function initGame(){
resizeCanvas();
loadGame();
game.map=createMap();
generateDigsites();
generateBackgroundElements();
generateMapObjects();
generateAmbiance();
// Adjust player spawn if blocked
let playerTileX = Math.floor(game.player.x / TILE_SIZE);
let playerTileY = Math.floor(game.player.y / TILE_SIZE);
if (!isWalkable(game.player.x, game.player.y)) {
  let found = false;
  for (let radius = 1; radius < 10 && !found; radius++) {
    for (let dx = -radius; dx <= radius && !found; dx++) {
      for (let dy = -radius; dy <= radius && !found; dy++) {
        if (Math.abs(dx) + Math.abs(dy) === radius) {
          let nx = playerTileX + dx;
          let ny = playerTileY + dy;
          if (nx >= 0 && nx < MAP_WIDTH && ny >= 0 && ny < MAP_HEIGHT && game.map[ny][nx] === 'g') {
            game.player.x = nx * TILE_SIZE + TILE_SIZE / 2;
            game.player.y = ny * TILE_SIZE + TILE_SIZE / 2;
            found = true;
          }
        }
      }
    }
  }
}
updateHUD();
updateDpadVisibility();
window.addEventListener('resize',resizeCanvas);
window.addEventListener('keydown',handleKeydown);
window.addEventListener('keyup',handleKeyup);
canvas.addEventListener('click',handleMouseClick);
showControlSchemeSelector();
setInterval(updateGame,1000/60);
}
initGame();
</script>
</body>
</html>
